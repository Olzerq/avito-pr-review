# PR Reviewer Assignment Service

Данный сервис реализует бизнес-логику автоматического назначения ревьюверов на Pull Request'ы в команде. Поддерживаются операции создания команд, управления активностью пользователей, создания и переназначения PR, а также получение статистики.

## Стек технологий

- Go 1.23
- PostgreSQL 15
- Docker + Docker Compose
- Chi (HTTP Router)
- pgx/v5 (драйвер PostgreSQL)
- golang-migrate (миграции)
- k6 (нагрузочное тестирование)

## Запуск сервиса

### Требования

- Docker
- Docker Compose

### Запуск командой

```shell script
docker-compose up --build
```

После старта сервис будет доступен по адресу: http://localhost:8080

База данных будет развёрнута в контейнере, миграции применяются автоматически.

## Конфигурация

Все переменные окружения хранятся в файле `.env` с предустановленными стандартными значениями:

```
APP_PORT=8080

DB_HOST=db
DB_PORT=5432
DB_USER=avito_user
DB_PASSWORD=avito_password
DB_NAME=avito_prs
```

## Структура репозитория

```
/cmd/app/            — точка входа
/internal/
    config/          — конфигурация приложения
    http/            — HTTP handlers
    model/           — структуры домена
    repository/      — доступ к БД 
    service/         — бизнес-логика
    tests/           — интеграционные тесты
/migrations/         — sql-миграции
/loadtests/          — нагрузочные тесты (k6)
Dockerfile
docker-compose.yml
.env                 — переменные окружения
README.md
```

## API

### Основные эндпоинты:

#### Команды
- `POST /team/add` - Добавить команду
- `GET /team/get` - Получить информацию о команде

#### Пользователи
- `POST /users/setIsActive` - Установить активность пользователя
- `GET /users/getReview` - Получить текущие ревью пользователя

#### Pull Requests
- `POST /pullRequest/create` - Создать PR
- `POST /pullRequest/reassign` - Переназначить ревьювера
- `POST /pullRequest/merge` - Зафиксировать выполнение PR

#### Статистика
- `GET /stats/assignments` - Получить статистику назначений

## Логика назначения ревьюверов

### Создание PR:
1. Ищем команду автора PR
2. Берём всех активных участников команды, кроме автора
3. Берём максимум 2 ревьюверов
4. Выбор случайный, но повторяемый (не повторяем одного и того же ревьювера дважды)

### Переназначение ревьювера:
1. Проверяем, что PR существует
2. Проверяем, что старый ревьювер назначен
3. Проверяем, что PR в статусе OPEN
4. Находим активного кандидата-ротацию
5. Записываем замену

## Тестирование

### Интеграционные тесты
К сожалению, мне не хватило времени покрыть весь код нормальными тестами, поэтому я покрыл только часть. Я собираюсь доработать это и другие аспекты из дополнительных заданий после дедлайна.

#### Запуск тестов:
```shell script
go test ./...
```

### Нагрузочное тестирование (k6)
#Эту тему я изучал во время выполнения задания, поэтому не так сильно силен в ней
Необходимо установить k6, либо с официального сайта, либо командой:
```shell script
choco install k6
```

#### Запуск нагрузочного тестирования:
```shell script
k6 run -e BASE_URL=http://localhost:8080 loadtests/create_pr_k6.js
```

Результаты показали среднюю задержку < 10ms при 100 параллельных пользователях.

## Code style / Lint

Для проверки стиля и типичных ошибок используется `golangci-lint`.

#### Запуск линтера:
```shell script
golangci-lint run ./...
```
